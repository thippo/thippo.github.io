<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë∂≥Ëøπ</title>
    <link rel="stylesheet" href="leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        #map-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Âú∞ÂõæÊ∫êÈÄâÊã©Âô® */
        .map-source-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            min-width: 180px;
        }

        .map-source-selector h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .source-option {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 13px;
        }

        .source-option:hover {
            background: #f0f0f0;
        }

        .source-option.active {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .source-option input[type="radio"] {
            margin-right: 8px;
        }

        /* ÁªüËÆ°Ê†è */
        .stats-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        /* Âä†ËΩΩÂíåÈîôËØØÂ§ÑÁêÜ */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: none;
        }

        .loading-indicator.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            background: #ff5252;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            animation: slideDown 0.3s ease;
        }

        .error-notification.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .tile-error-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }

        .tile-error-overlay.show {
            display: block;
        }

        /* Ëá™ÂÆö‰πâÊ†áËÆ∞Ê†∑Âºè */
        .custom-div-icon {
            background: none;
            border: none;
        }

        .marker-pin {
            width: 20px;
            height: 20px;
            border-radius: 50% 50% 50% 0;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -20px 0 0 -20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .marker-pin:hover {
            transform: rotate(-45deg) scale(1.1);
        }

        .marker-pin.country {
            background: #ff7043;
            opacity: 0.8;
            width: 20px;
            height: 20px;
            margin: -26px 0 0 -26px;
        }

        .marker-pin.city {
            background: #ab47bc;
            opacity: 0.8;
            width: 20px;
            height: 20px;
            margin: -20px 0 0 -20px;
        }

        .marker-pin.spot {
            background: #42a5f5;
            opacity: 0.8;
            width: 15px;
            height: 15px;
            margin: -17px 0 0 -17px;
        }

        .marker-icon {
            transform: rotate(45deg);
            color: white;
            font-size: 14px;
        }

        .marker-pin.country .marker-icon {
            font-size: 16px;
        }

        .marker-pin.city .marker-icon {
            font-size: 14px;
        }

        .marker-pin.spot .marker-icon {
            font-size: 12px;
        }

        /* Ëá™ÂÆö‰πâÂºπÁ™óÊ†∑Âºè */
        .custom-popup h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #333;
        }

        .custom-popup .popup-path {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .custom-popup .popup-date {
            font-size: 12px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .custom-popup .popup-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .map-source-selector {
                max-width: 150px;
                top: 10px;
                right: 10px;
            }

            .stats-bar {
                bottom: 10px;
                left: 10px;
                right: 10px;
                justify-content: space-around;
                border-radius: 20px;
            }

        }
    </style>
<base target="_blank">
</head>
<body>
    <div id="map-container">
        <div id="map"></div>

        <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
        <div id="loading-indicator" class="loading-indicator">
            <div class="spinner"></div>
            <p style="color: #666;">Ê≠£Âú®Âä†ËΩΩÂú∞Âõæ...</p>
        </div>

        <!-- ÈîôËØØÊèêÁ§∫ -->
        <div id="error-notification" class="error-notification">
            Âú∞ÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÂàáÊç¢Âú∞ÂõæÊ∫êÊàñÊ£ÄÊü•ÁΩëÁªúËøûÊé•
        </div>

        <!-- Áì¶ÁâáÈîôËØØÊèêÁ§∫ -->
        <div id="tile-error-overlay" class="tile-error-overlay">
            ‚ö†Ô∏è ÈÉ®ÂàÜÂú∞ÂõæÂå∫ÂüüÂä†ËΩΩÂ§±Ë¥•
        </div>

        <!-- Âú∞ÂõæÊ∫êÈÄâÊã©Âô® -->
        <div class="map-source-selector">
            <h3>Âú∞ÂõæÊ∫ê</h3>
            <div class="source-option active">
                <input type="radio" id="source4" name="mapSource" value="esri" checked>
                <label for="source4">ESRI (Êé®Ëçê)</label>
            </div>
            <div class="source-option">
                <input type="radio" id="source1" name="mapSource" value="cartodb">
                <label for="source1">CartoDB (Â§áÁî®)</label>
            </div>
        </div>

        <!-- ÁªüËÆ°Ê†è -->
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="stat-countries">0</div>
                <div class="stat-label">ÂõΩÂÆ∂</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-cities">0</div>
                <div class="stat-label">ÂüéÂ∏Ç</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-spots">0</div>
                <div class="stat-label">ÊôØÁÇπ</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-zoom">3</div>
                <div class="stat-label">Áº©Êîæ</div>
            </div>
        </div>
    </div>

    <script src="leaflet.min.js"></script>
    <script src="data.js"></script>
    <script>
        // Âú∞ÂõæÁõ∏ÂÖ≥ÂèòÈáè
        let map;
        let currentLayer;
        let markers = [];
        let failedTiles = 0;
        let totalTiles = 0;

        // Áº©ÊîæÁ∫ßÂà´ÈÖçÁΩÆ
        const zoomConfig = {
            country: { min: 0, max: 4, name: 'ÂõΩÂÆ∂' },
            city: { min: 4, max: 5, name: 'ÂüéÂ∏Ç' },
            spot: { min: 5, max: 20, name: 'ÊôØÁÇπ' }
        };

        // Âú∞ÂõæÊ∫êÈÖçÁΩÆ
        const mapSources = {
            esri: {
                name: 'ESRI',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                attribution: '&copy; <a href="https://www.esri.com/">ESRI</a>',
                subdomains: ['server', 'services'],
                minZoom: 3,
                maxZoom: 13
            },
            cartodb: {
                name: 'CartoDB',
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: ['a', 'b', 'c', 'd'],
                maxZoom: 19
            },
        };

        // ÂàùÂßãÂåñ
        function init() {
            initMap();
            updateStats();
            document.getElementById('loading-indicator').style.display = 'none';
        }

        function initMap() {
            showLoading(true);

            map = L.map('map', {
                zoomControl: false,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: true,
                keyboard: true,
                worldCopyJump: true
            }).setView([30, 0], 3);

            // ÁõëÂê¨Áì¶ÁâáÂä†ËΩΩ‰∫ã‰ª∂
            map.on('tileloadstart', function() {
                totalTiles++;
            });

            map.on('tileerror', function(e) {
                failedTiles++;
                if (failedTiles > 3) {
                    showTileError(true);
                }
            });

            map.on('load', function() {
                showLoading(false);
                if (failedTiles > 0) {
                    showNotification(`Âä†ËΩΩÂÆåÊàêÔºå${failedTiles}‰∏™Áì¶ÁâáÂä†ËΩΩÂ§±Ë¥•`);
                }
            });

            // Ê∑ªÂä†ÈªòËÆ§ÂõæÂ±Ç
            changeMapSource('esri');

            // ÁõëÂê¨Áº©Êîæ‰∫ã‰ª∂ - Ê†∏ÂøÉÂäüËÉΩ
            map.on('zoomend', function() {
                const zoom = map.getZoom();
                document.getElementById('stat-zoom').textContent = zoom;
                updateMarkersByZoom(zoom);
            });

            // ÂàùÂßãÊòæÁ§∫Ê†áËÆ∞
            updateMarkersByZoom(map.getZoom());
        }

        // Ê†πÊçÆÁº©ÊîæÁ∫ßÂà´Êõ¥Êñ∞Ê†áËÆ∞ - ‰øÆÊ≠£ÁâàÔºöÂè™ÊòæÁ§∫ÂΩìÂâçÂ±ÇÁ∫ßÔºåÈöêËóè‰∏ä‰∏ÄÁ∫ß
        function updateMarkersByZoom(zoom) {
            clearMarkers();
                geoData.forEach(country => {
                    if (country.children) {
                        country.children.forEach(city => {
                            if (city.type === 'city' && city.children) {
                                city.children.forEach(spot => {
                                    if (spot.type === 'spot') {
                                        addMarker(spot, 'spot');
                                    }
                                });
                            }
                        });
                    }
                });

        }

        // ÂàáÊç¢Âú∞ÂõæÊ∫ê
        function changeMapSource(sourceName) {
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            const source = mapSources[sourceName];

            currentLayer = L.tileLayer(source.url, {
                attribution: source.attribution,
                minZoom: source.minZoom,
                maxZoom: source.maxZoom,
                subdomains: source.subdomains,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7lsIHpnaLlm77niYfmuLjmuLLvvIzkuI3mlLnlj5HkvZPvvIw+PC90ZXh0Pjwvc3ZnPg==',
                timeout: 8000
            });

            currentLayer.on('load', function() {
                showLoading(false);
                if (failedTiles === 0) {
                    showNotification('Âú∞ÂõæÂä†ËΩΩÊàêÂäüÔºÅ', 'success');
                }
            });

            currentLayer.on('error', function(e) {
                showNotification('Âú∞ÂõæÊ∫êÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÊ∫ê', 'error');
                showLoading(false);
            });

            currentLayer.addTo(map);

            // Êõ¥Êñ∞UIÁä∂ÊÄÅ
            document.querySelectorAll('.source-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`input[value="${sourceName}"]`).parentElement.classList.add('active');
        }

        // Ê∑ªÂä†Ê†áËÆ∞
        function addMarker(data, type) {
            const iconClass = type;
            const iconSize = type === 'country' ? '16px' : type === 'city' ? '14px' : '12px';

            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="marker-pin ${iconClass}">
                        <div class="marker-icon" style="font-size: ${iconSize};">
                            ${type === 'country' ? '' : type === 'city' ? '' : data.icon || ''}
                        </div>
                    </div>
                `,
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });

            const marker = L.marker([data.lat, data.lng], { icon: icon })
                .addTo(map)
                .bindPopup(`
                    <div class="custom-popup">
                        <h3>${data.name}</h3>
                        <div class="popup-path">${getFullPath(data)}</div>
                        ${data.date ? `<div class="popup-date">üìÖ ${data.date}</div>` : ''}
                        ${data.description ? `<div class="popup-desc">${data.description}</div>` : ''}
                    </div>
                `);

            marker.locationId = data.id;
            marker.locationType = type;
            markers.push(marker);
        }

        // Ëé∑ÂèñÂÆåÊï¥Ë∑ØÂæÑ
        function getFullPath(node) {
            const path = [];

            function findPath(nodes, targetId, currentPath) {
                for (let node of nodes) {
                    const newPath = [...currentPath, node.name];
                    if (node.id === targetId) {
                        return newPath;
                    }
                    if (node.children) {
                        const result = findPath(node.children, targetId, newPath);
                        if (result) return result;
                    }
                }
                return null;
            }

            const result = findPath(geoData, node.id, []);
            return result ? result.join(' > ') : node.name;
        }

        // Ê∏ÖÈô§Ê†áËÆ∞
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats() {
            let countries = 0, cities = 0, spots = 0;

            function count(node) {
                if (node.type === 'country') countries++;
                else if (node.type === 'city') cities++;
                else if (node.type === 'spot') spots++;

                if (node.children) node.children.forEach(count);
            }

            geoData.forEach(count);

            document.getElementById('stat-countries').textContent = countries;
            document.getElementById('stat-cities').textContent = cities;
            document.getElementById('stat-spots').textContent = spots;
        }

        // ÈîôËØØÂ§ÑÁêÜÂíåÂä†ËΩΩÁä∂ÊÄÅ
        function showLoading(show) {
            const indicator = document.getElementById('loading-indicator');
            if (show) {
                indicator.classList.add('show');
            } else {
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 500);
            }
        }

        function showTileError(show) {
            const overlay = document.getElementById('tile-error-overlay');
            if (show) {
                overlay.classList.add('show');
                setTimeout(() => {
                    overlay.classList.remove('show');
                }, 5000);
            } else {
                overlay.classList.remove('show');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('error-notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#ff5252' : 
                                          type === 'warning' ? '#ff9800' : 
                                          type === 'success' ? '#4CAF50' : '#2196F3';
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Âú∞ÂõæÊ∫êÂàáÊç¢‰∫ã‰ª∂
        document.querySelectorAll('input[name="mapSource"]').forEach(radio => {
            radio.addEventListener('change', function() {
                changeMapSource(this.value);
            });
        });

        // Á™óÂè£Ë∞ÉÊï¥
        window.onresize = () => {
            if (map) map.invalidateSize();
        };

        // ÂêØÂä®
        window.onload = init;
    </script>
</body>
</html>