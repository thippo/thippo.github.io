<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶³è¿¹</title>
    <link rel="stylesheet" href="leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        #map-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* åœ°å›¾æºé€‰æ‹©å™¨ */
        .map-source-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            min-width: 180px;
        }

        .map-source-selector h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .source-option {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 13px;
        }

        .source-option:hover {
            background: #f0f0f0;
        }

        .source-option.active {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .source-option input[type="radio"] {
            margin-right: 8px;
        }

        /* ç»Ÿè®¡æ  */
        .stats-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        /* åŠ è½½å’Œé”™è¯¯å¤„ç† */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: none;
        }

        .loading-indicator.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            background: #ff5252;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            animation: slideDown 0.3s ease;
        }

        .error-notification.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .tile-error-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }

        .tile-error-overlay.show {
            display: block;
        }

        /* è‡ªå®šä¹‰æ ‡è®°æ ·å¼ */
        .custom-div-icon {
            background: none;
            border: none;
        }

        .marker-pin {
            width: 20px;
            height: 20px;
            border-radius: 50% 50% 50% 0;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -20px 0 0 -20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .marker-pin:hover {
            transform: rotate(-45deg) scale(1.1);
        }

        .marker-pin.country {
            background: #ff7043;
            opacity: 0.8;
            width: 20px;
            height: 20px;
            margin: -26px 0 0 -26px;
        }

        .marker-pin.city {
            background: #ab47bc;
            opacity: 0.8;
            width: 20px;
            height: 20px;
            margin: -20px 0 0 -20px;
        }

        .marker-pin.spot {
            background: #42a5f5;
            opacity: 0.8;
            width: 15px;
            height: 15px;
            margin: -17px 0 0 -17px;
        }

        .marker-icon {
            transform: rotate(45deg);
            color: white;
            font-size: 14px;
        }

        .marker-pin.country .marker-icon {
            font-size: 16px;
        }

        .marker-pin.city .marker-icon {
            font-size: 14px;
        }

        .marker-pin.spot .marker-icon {
            font-size: 12px;
        }

        /* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
        .custom-popup h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #333;
        }

        .custom-popup .popup-path {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .custom-popup .popup-date {
            font-size: 12px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .custom-popup .popup-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .map-source-selector {
                max-width: 150px;
                top: 10px;
                right: 10px;
            }

            .stats-bar {
                bottom: 10px;
                left: 10px;
                right: 10px;
                justify-content: space-around;
                border-radius: 20px;
            }

        }
    </style>
<base target="_blank">
</head>
<body>
    <div id="map-container">
        <div id="map"></div>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div id="loading-indicator" class="loading-indicator">
            <div class="spinner"></div>
            <p style="color: #666;">æ­£åœ¨åŠ è½½åœ°å›¾...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error-notification" class="error-notification">
            åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ‡æ¢åœ°å›¾æºæˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥
        </div>

        <!-- ç“¦ç‰‡é”™è¯¯æç¤º -->
        <div id="tile-error-overlay" class="tile-error-overlay">
            âš ï¸ éƒ¨åˆ†åœ°å›¾åŒºåŸŸåŠ è½½å¤±è´¥
        </div>

        <!-- åœ°å›¾æºé€‰æ‹©å™¨ -->
        <div class="map-source-selector">
            <h3>åœ°å›¾æº</h3>
            <div class="source-option active">
                <input type="radio" id="source1" name="mapSource" value="esri" checked>
                <label for="source1">ESRI (æ¨è)</label>
            </div>
            <div class="source-option">
                <input type="radio" id="source2" name="mapSource" value="cartodb">
                <label for="source2">CartoDB (å¤‡ç”¨)</label>
            </div>
            <div class="source-option">
                <input type="radio" id="source3" name="mapSource" value="gaode">
                <label for="source3">é«˜å¾·åœ°å›¾ (å¤‡ç”¨)</label>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ  -->
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="stat-countries">0</div>
                <div class="stat-label">å›½å®¶</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-cities">0</div>
                <div class="stat-label">åŸå¸‚</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-spots">0</div>
                <div class="stat-label">æ™¯ç‚¹</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-zoom">3</div>
                <div class="stat-label">ç¼©æ”¾</div>
            </div>
        </div>
    </div>

    <script src="leaflet.min.js"></script>
    <script src="data.js"></script>
    <script>
        // åœ°å›¾ç›¸å…³å˜é‡
        let map;
        let currentLayer;
        let markers = [];
        let failedTiles = 0;
        let totalTiles = 0;

        // ç¼©æ”¾çº§åˆ«é…ç½®
        const zoomConfig = {
            country: { min: 0, max: 4, name: 'å›½å®¶' },
            city: { min: 4, max: 5, name: 'åŸå¸‚' },
            spot: { min: 5, max: 20, name: 'æ™¯ç‚¹' }
        };

        /**
        * WGS-84 è½¬ GCJ-02ï¼ˆé«˜å¾·/è…¾è®¯åœ°å›¾é€šç”¨ï¼‰
        * è¿”å› [lng, lat]
        */
        function wgs84_to_gcj02(lat, lng) {
         const PI = Math.PI;
         const A = 6378245.0;           // é•¿åŠè½´
         const EE = 0.00669342162296594323; // æ‰ç‡
        
         function outOfChina(lng, lat) {
           return lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271;
         }
         function transformLat(lng, lat) {
           let ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.001 * lat * lat * lat + 0.2 * Math.sin(PI * lng * 300.0 / 180.0);
           ret += (20.0 * Math.sin(PI * lng * 6.0 / 180.0) + 20.0 * Math.sin(PI * lng * 2.0 / 180.0)) * 2.0 / 3.0;
           ret += (20.0 * Math.sin(PI * lat * 2.0 / 180.0) + 40.0 * Math.sin(PI * lat * 4.0 / 180.0)) * 2.0 / 3.0;
           return ret;
         }
         function transformLng(lng, lat) {
           let ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.001 * lng * lng * lng + 0.1 * Math.sin(PI * lng * 300.0 / 180.0);
           ret += (20.0 * Math.sin(PI * lng * 6.0 / 180.0) + 20.0 * Math.sin(PI * lng * 2.0 / 180.0)) * 2.0 / 3.0;
           ret += (150.0 * Math.sin(PI * lng * 3.0 / 180.0) + 300.0 * Math.sin(PI * lng * 5.0 / 180.0)) * 2.0 / 3.0;
           return ret;
         }
     
         if (outOfChina(lng, lat)) return [lng, lat];
     
         let dLat = transformLat(lng - 105.0, lat - 35.0);
         let dLng = transformLng(lng - 105.0, lat - 35.0);
         const radLat = lat / 180.0 * PI;
         let magic = Math.sin(radLat);
         magic = 1 - EE * magic * magic;
         const sqrtMagic = Math.sqrt(magic);
         dLat = (dLat * 180.0) / ((A * (1 - EE)) / (magic * sqrtMagic) * PI);
         dLng = (dLng * 180.0) / (A / sqrtMagic * Math.cos(radLat) * PI);
         return [lat + dLat, lng + dLng];
        }
        // åœ°å›¾æºé…ç½®
        const mapSources = {
            esri: {
                name: 'ESRI',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                attribution: '&copy; <a href="https://www.esri.com/">ESRI</a>',
                subdomains: ['server', 'services'],
                minZoom: 3,
                maxZoom: 13
            },
            cartodb: {
                name: 'CartoDB',
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: ['a', 'b', 'c', 'd'],
                maxZoom: 19
            },
            gaode: {
                name: 'é«˜å¾·åœ°å›¾',
                url: 'https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
                attribution: '&copy; <a href="https://www.autonavi.com/">é«˜å¾·åœ°å›¾</a>',
                subdomains: ['1', '2', '3', '4'],
                maxZoom: 18
            },
        };

        // åˆå§‹åŒ–
        function init() {
            initMap();
            updateStats();
            document.getElementById('loading-indicator').style.display = 'none';
        }

        function initMap() {
            showLoading(true);

            map = L.map('map', {
                zoomControl: false,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: true,
                keyboard: true,
                worldCopyJump: true
            }).setView([30, 0], 3);

            // ç›‘å¬ç“¦ç‰‡åŠ è½½äº‹ä»¶
            map.on('tileloadstart', function() {
                totalTiles++;
            });

            map.on('tileerror', function(e) {
                failedTiles++;
                if (failedTiles > 3) {
                    showTileError(true);
                }
            });

            map.on('load', function() {
                showLoading(false);
                if (failedTiles > 0) {
                    showNotification(`åŠ è½½å®Œæˆï¼Œ${failedTiles}ä¸ªç“¦ç‰‡åŠ è½½å¤±è´¥`);
                }
            });

            // æ·»åŠ é»˜è®¤å›¾å±‚
            changeMapSource('esri');

            // ç›‘å¬ç¼©æ”¾äº‹ä»¶ - æ ¸å¿ƒåŠŸèƒ½
            map.on('zoomend', function() {
                const zoom = map.getZoom();
                document.getElementById('stat-zoom').textContent = zoom;
                updateMarkersByZoom(zoom);
            });

            // åˆå§‹æ˜¾ç¤ºæ ‡è®°
            updateMarkersByZoom(map.getZoom());
        }

        // æ ¹æ®ç¼©æ”¾çº§åˆ«æ›´æ–°æ ‡è®° - ä¿®æ­£ç‰ˆï¼šåªæ˜¾ç¤ºå½“å‰å±‚çº§ï¼Œéšè—ä¸Šä¸€çº§
        function updateMarkersByZoom(zoom) {
            clearMarkers();
                geoData.forEach(country => {
                    if (country.children) {
                        country.children.forEach(city => {
                            if (city.type === 'city' && city.children) {
                                city.children.forEach(spot => {
                                    if (spot.type === 'spot') {
                                        addMarker(spot, 'spot');
                                    }
                                });
                            }
                        });
                    }
                });

        }

        // åˆ‡æ¢åœ°å›¾æº
        function changeMapSource(sourceName) {
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            const source = mapSources[sourceName];

            currentLayer = L.tileLayer(source.url, {
                attribution: source.attribution,
                minZoom: source.minZoom,
                maxZoom: source.maxZoom,
                subdomains: source.subdomains,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7lsIHpnaLlm77niYfmuLjmuLLvvIzkuI3mlLnlj5HkvZPvvIw+PC90ZXh0Pjwvc3ZnPg==',
                timeout: 8000
            });

            currentLayer.on('load', function() {
                showLoading(false);
                if (failedTiles === 0) {
                    showNotification('åœ°å›¾åŠ è½½æˆåŠŸï¼', 'success');
                }
            });

            currentLayer.on('error', function(e) {
                showNotification('åœ°å›¾æºåŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æº', 'error');
                showLoading(false);
            });

            currentLayer.addTo(map);

            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.source-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`input[value="${sourceName}"]`).parentElement.classList.add('active');
        }

        // æ·»åŠ æ ‡è®°
        function addMarker(data, type) {
            const iconClass = type;
            const iconSize = type === 'country' ? '16px' : type === 'city' ? '14px' : '12px';

            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="marker-pin ${iconClass}">
                        <div class="marker-icon" style="font-size: ${iconSize};">
                            ${type === 'country' ? '' : type === 'city' ? '' : data.icon || ''}
                        </div>
                    </div>
                `,
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });

            const marker = L.marker(wgs84_to_gcj02(data.lat, data.lng), { icon: icon })
                .addTo(map)
                .bindPopup(`
                    <div class="custom-popup">
                        <h3>${data.name}</h3>
                        <div class="popup-path">${getFullPath(data)}</div>
                        ${data.date ? `<div class="popup-date">ğŸ“… ${data.date}</div>` : ''}
                        ${data.description ? `<div class="popup-desc">${data.description}</div>` : ''}
                    </div>
                `);

            marker.locationId = data.id;
            marker.locationType = type;
            markers.push(marker);
        }

        // è·å–å®Œæ•´è·¯å¾„
        function getFullPath(node) {
            const path = [];

            function findPath(nodes, targetId, currentPath) {
                for (let node of nodes) {
                    const newPath = [...currentPath, node.name];
                    if (node.id === targetId) {
                        return newPath;
                    }
                    if (node.children) {
                        const result = findPath(node.children, targetId, newPath);
                        if (result) return result;
                    }
                }
                return null;
            }

            const result = findPath(geoData, node.id, []);
            return result ? result.join(' > ') : node.name;
        }

        // æ¸…é™¤æ ‡è®°
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            let countries = 0, cities = 0, spots = 0;

            function count(node) {
                if (node.type === 'country') countries++;
                else if (node.type === 'city') cities++;
                else if (node.type === 'spot') spots++;

                if (node.children) node.children.forEach(count);
            }

            geoData.forEach(count);

            document.getElementById('stat-countries').textContent = countries;
            document.getElementById('stat-cities').textContent = cities;
            document.getElementById('stat-spots').textContent = spots;
        }

        // é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const indicator = document.getElementById('loading-indicator');
            if (show) {
                indicator.classList.add('show');
            } else {
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 500);
            }
        }

        function showTileError(show) {
            const overlay = document.getElementById('tile-error-overlay');
            if (show) {
                overlay.classList.add('show');
                setTimeout(() => {
                    overlay.classList.remove('show');
                }, 5000);
            } else {
                overlay.classList.remove('show');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('error-notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#ff5252' : 
                                          type === 'warning' ? '#ff9800' : 
                                          type === 'success' ? '#4CAF50' : '#2196F3';
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // åœ°å›¾æºåˆ‡æ¢äº‹ä»¶
        document.querySelectorAll('input[name="mapSource"]').forEach(radio => {
            radio.addEventListener('change', function() {
                changeMapSource(this.value);
            });
        });

        // çª—å£è°ƒæ•´
        window.onresize = () => {
            if (map) map.invalidateSize();
        };

        // å¯åŠ¨
        window.onload = init;
    </script>
</body>
</html>