<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨³å®šå¤šå±‚çº§åœ°å›¾ç³»ç»Ÿ - æ™¯ç‚¹æ ‡è®°</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css " />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        #map-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* åœ°å›¾æºé€‰æ‹©å™¨ */
        .map-source-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            min-width: 180px;
        }

        .map-source-selector h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .source-option {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 13px;
        }

        .source-option:hover {
            background: #f0f0f0;
        }

        .source-option.active {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .source-option input[type="radio"] {
            margin-right: 8px;
        }

        /* å±‚çº§å¯¼èˆªé¢æ¿ */
        .hierarchy-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            max-height: 60vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .hierarchy-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .breadcrumb-item:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .breadcrumb-item.active {
            color: #1976d2;
            font-weight: 600;
        }

        .breadcrumb-separator {
            color: #bbb;
        }

        /* æ ‘å½¢ç»“æ„æ ·å¼ */
        .tree-list {
            list-style: none;
        }

        .tree-item {
            margin: 5px 0;
        }

        .tree-header {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            background: #fff;
            border: 1px solid #e0e0e0;
        }

        .tree-header:hover {
            background: #f5f5f5;
            transform: translateX(5px);
        }

        .tree-header.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .tree-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
        }

        .icon-country {
            background: #ff7043;
            color: white;
        }

        .icon-city {
            background: #ab47bc;
            color: white;
        }

        .icon-spot {
            background: #42a5f5;
            color: white;
        }

        .tree-content {
            flex: 1;
        }

        .tree-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .tree-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        .expand-icon {
            margin-left: auto;
            transition: transform 0.3s;
            color: #999;
        }

        .expanded .expand-icon {
            transform: rotate(90deg);
        }


        /* ç»Ÿè®¡æ  */
        .stats-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        /* åŠ è½½å’Œé”™è¯¯å¤„ç† */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: none;
        }

        .loading-indicator.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            background: #ff5252;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            animation: slideDown 0.3s ease;
        }

        .error-notification.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .tile-error-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }

        .tile-error-overlay.show {
            display: block;
        }

        /* è‡ªå®šä¹‰æ ‡è®°æ ·å¼ */
        .custom-div-icon {
            background: none;
            border: none;
        }

        .marker-pin {
            width: 40px;
            height: 40px;
            border-radius: 50% 50% 50% 0;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -20px 0 0 -20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .marker-pin:hover {
            transform: rotate(-45deg) scale(1.1);
        }

        .marker-pin.country {
            background: #ff7043;
        }

        .marker-pin.city {
            background: #ab47bc;
            width: 35px;
            height: 35px;
            margin: -17.5px 0 0 -17.5px;
        }

        .marker-pin.spot {
            background: #42a5f5;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
        }

        .marker-icon {
            transform: rotate(45deg);
            color: white;
            font-size: 16px;
        }

        .marker-pin.city .marker-icon {
            font-size: 14px;
        }

        .marker-pin.spot .marker-icon {
            font-size: 12px;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin: 5px 0;
        }

        .btn-zoom-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-zoom-out {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
            width: 100%;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .hierarchy-panel {
                max-width: 250px;
                max-height: 50vh;
                top: 10px;
                left: 10px;
            }

            .map-source-selector {
                max-width: 150px;
                top: 10px;
                right: 10px;
            }

            .controls {
                bottom: 10px;
                right: 10px;
            }

            .stats-bar {
                bottom: 10px;
                left: 10px;
                right: 10px;
                justify-content: space-around;
                border-radius: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        
        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div id="loading-indicator" class="loading-indicator">
            <div class="spinner"></div>
            <p style="color: #666;">æ­£åœ¨åŠ è½½åœ°å›¾...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error-notification" class="error-notification">
            åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ‡æ¢åœ°å›¾æºæˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥
        </div>

        <!-- ç“¦ç‰‡é”™è¯¯æç¤º -->
        <div id="tile-error-overlay" class="tile-error-overlay">
            âš ï¸ éƒ¨åˆ†åœ°å›¾åŒºåŸŸåŠ è½½å¤±è´¥
        </div>

        <!-- åœ°å›¾æºé€‰æ‹©å™¨ -->
        <div class="map-source-selector">
            <h3>ğŸ—ºï¸ åœ°å›¾æº</h3>
            <div class="source-option active">
                <input type="radio" id="source1" name="mapSource" value="cartodb" checked>
                <label for="source1">CartoDB (æ¨è)</label>
            </div>
            <div class="source-option">
                <input type="radio" id="source2" name="mapSource" value="osm">
                <label for="source2">OpenStreetMap</label>
            </div>
            <div class="source-option">
                <input type="radio" id="source3" name="mapSource" value="stamen">
                <label for="source3">Stamen (å¤‡ç”¨)</label>
            </div>
            <div class="source-option">
                <input type="radio" id="source4" name="mapSource" value="esri">
                <label for="esri">ESRI (å¤‡ç”¨)</label>
            </div>
            <button class="refresh-btn" onclick="refreshMap()">ğŸ”„ åˆ·æ–°åœ°å›¾</button>
        </div>

        <!-- å±‚çº§å¯¼èˆªé¢æ¿ -->
        <div class="hierarchy-panel">
            <h2>ğŸŒ åœ°ç†ä½ç½®</h2>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item active" onclick="showLevel('world')">ä¸–ç•Œ</span>
            </div>
            <ul class="tree-list" id="tree-list"></ul>
        </div>


        <!-- ç»Ÿè®¡æ  -->
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="stat-countries">0</div>
                <div class="stat-label">å›½å®¶</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-cities">0</div>
                <div class="stat-label">åŸå¸‚</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-spots">0</div>
                <div class="stat-label">æ™¯ç‚¹</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-zoom">3</div>
                <div class="stat-label">ç¼©æ”¾</div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="btn btn-zoom-in" onclick="zoomIn()">
                <span>â•</span> æ”¾å¤§
            </button>
            <button class="btn btn-zoom-in" onclick="zoomToLevel(10)" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);">
                <span>ğŸ™ï¸</span> åŸå¸‚çº§
            </button>
            <button class="btn btn-zoom-in" onclick="zoomToLevel(16)" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                <span>ğŸ“</span> æ™¯ç‚¹çº§
            </button>
            <button class="btn btn-zoom-out" onclick="zoomOut()">
                <span>â–</span> ç¼©å°
            </button>
            <button class="btn btn-reset" onclick="resetView()">
                <span>ğŸŒ</span> å…¨çƒè§†å›¾
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js "></script>
    <script>
        // å±‚çº§åŒ–åœ°ç†ä½ç½®æ•°æ®ï¼ˆåŒ…å«è¯¦ç»†æ™¯ç‚¹ä¿¡æ¯ï¼‰
        const geoData = [
            {
                id: "cn",
                name: "ä¸­å›½",
                type: "country",
                lat: 35.8617,
                lng: 104.1954,
                zoom: 4,
                children: [
                    {
                        id: "cn-bj",
                        name: "åŒ—äº¬",
                        type: "city",
                        lat: 39.9042,
                        lng: 116.4074,
                        zoom: 10,
                        children: [
                            {
                                id: "cn-bj-gc",
                                name: "æ•…å®«",
                                type: "spot",
                                lat: 39.9163,
                                lng: 116.3972,
                                date: "2024-01-15",
                                description: "ä¸­å›½æ˜æ¸…ä¸¤ä»£çš„çš‡å®¶å®«æ®¿ï¼Œæ—§ç§°ç´«ç¦åŸï¼Œæ˜¯ä¸–ç•Œä¸Šç°å­˜è§„æ¨¡æœ€å¤§ã€ä¿å­˜æœ€ä¸ºå®Œæ•´çš„æœ¨è´¨ç»“æ„å¤å»ºç­‘ä¹‹ä¸€ã€‚",
                                icon: "ğŸ¯"
                            },
                            {
                                id: "cn-bj-tt",
                                name: "å¤©å›",
                                type: "spot",
                                lat: 39.8822,
                                lng: 116.4066,
                                date: "2024-01-16",
                                description: "æ˜æ¸…ä¸¤ä»£çš‡å¸ç¥­å¤©ã€ç¥ˆè°·çš„åœºæ‰€ï¼Œä¸»è¦å»ºç­‘æœ‰ç¥ˆå¹´æ®¿ã€çš‡ç©¹å®‡ã€åœœä¸˜ã€‚",
                                icon: "ğŸ›•"
                            },
                            {
                                id: "cn-bj-ccd",
                                name: "é•¿åŸï¼ˆå…«è¾¾å²­ï¼‰",
                                type: "spot",
                                lat: 40.3599,
                                lng: 116.0200,
                                date: "2024-01-17",
                                description: "ä¸‡é‡Œé•¿åŸçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œæ˜¯æ˜é•¿åŸçš„ä¸€ä¸ªéš˜å£ï¼Œæ™¯è‰²å£®è§‚ï¼Œæ˜¯ä¸–ç•Œæ–‡åŒ–é—äº§ã€‚",
                                icon: "ğŸ§±"
                            },
                            {
                                id: "cn-bj-yhy",
                                name: "é¢å’Œå›­",
                                type: "spot",
                                lat: 39.9999,
                                lng: 116.2755,
                                date: "2024-01-18",
                                description: "æ¸…æœçš‡å®¶å›­æ—ï¼Œä»¥æ˜†æ˜æ¹–ã€ä¸‡å¯¿å±±ä¸ºåŸºå€ï¼Œæ±²å–æ±Ÿå—å›­æ—è®¾è®¡æ‰‹æ³•è€Œå»ºã€‚",
                                icon: "ğŸï¸"
                            }
                        ]
                    },
                    {
                        id: "cn-sh",
                        name: "ä¸Šæµ·",
                        type: "city",
                        lat: 31.2304,
                        lng: 121.4737,
                        zoom: 10,
                        children: [
                            {
                                id: "cn-sh-waitan",
                                name: "å¤–æ»©",
                                type: "spot",
                                lat: 31.2397,
                                lng: 121.4998,
                                date: "2024-03-10",
                                description: "ä¸Šæµ·çš„æ ‡å¿—æ€§æ™¯ç‚¹ï¼Œæ‹¥æœ‰52åº§é£æ ¼è¿¥å¼‚çš„å¤å…¸å¤å…´å¤§æ¥¼ï¼Œè¢«èª‰ä¸ºä¸‡å›½å»ºç­‘åšè§ˆç¾¤ã€‚",
                                icon: "ğŸ¢"
                            },
                            {
                                id: "cn-sh-dst",
                                name: "ä¸œæ–¹æ˜ç ",
                                type: "spot",
                                lat: 31.2397,
                                lng: 121.4998,
                                date: "2024-03-11",
                                description: "ä¸Šæµ·æ ‡å¿—æ€§æ–‡åŒ–æ™¯è§‚ä¹‹ä¸€ï¼Œä½äºæµ¦ä¸œæ–°åŒºé™†å®¶å˜´ï¼Œå¡”é«˜çº¦468ç±³ã€‚",
                                icon: "ğŸ—¼"
                            },
                            {
                                id: "cn-sh-dz",
                                name: "è±«å›­",
                                type: "spot",
                                lat: 31.2270,
                                lng: 121.4920,
                                date: "2024-03-12",
                                description: "æ˜ä»£ç§äººèŠ±å›­ï¼Œè·ä»Šå·²æœ‰å››ç™¾ä½™å¹´å†å²ï¼Œæ˜¯ä¸Šæµ·è€åŸå¢çš„å‘æºåœ°ã€‚",
                                icon: "ğŸ®"
                            }
                        ]
                    },
                    {
                        id: "cn-xa",
                        name: "è¥¿å®‰",
                        type: "city",
                        lat: 34.3416,
                        lng: 108.9398,
                        zoom: 10,
                        children: [
                            {
                                id: "cn-xa-bmy",
                                name: "å…µé©¬ä¿‘",
                                type: "spot",
                                lat: 34.3841,
                                lng: 109.2785,
                                date: "2024-05-20",
                                description: "ç§¦å§‹çš‡é™µå…µé©¬ä¿‘å‘ï¼Œè¢«èª‰ä¸ºä¸–ç•Œç¬¬å…«å¤§å¥‡è¿¹ï¼Œæ˜¯ä¸­å›½å¤ä»£è¾‰ç…Œæ–‡æ˜çš„ä¸€å¼ é‡‘å­—åç‰‡ã€‚",
                                icon: "âš”ï¸"
                            },
                            {
                                id: "cn-xa-dyt",
                                name: "å¤§é›å¡”",
                                type: "spot",
                                lat: 34.2209,
                                lng: 108.9636,
                                date: "2024-05-21",
                                description: "å”ä»£ç„å¥˜ä¸ºä¿å­˜ç”±å¤©ç«ºç»ä¸ç»¸ä¹‹è·¯å¸¦å›é•¿å®‰çš„ç»å·ä½›åƒä¸»æŒä¿®å»ºçš„ä½›å¡”ã€‚",
                                icon: "ğŸ•Œ"
                            }
                        ]
                    }
                ]
            },
            {
                id: "jp",
                name: "æ—¥æœ¬",
                type: "country",
                lat: 36.2048,
                lng: 138.2529,
                zoom: 5,
                children: [
                    {
                        id: "jp-tokyo",
                        name: "ä¸œäº¬",
                        type: "city",
                        lat: 35.6762,
                        lng: 139.6503,
                        zoom: 11,
                        children: [
                            {
                                id: "jp-tokyo-tower",
                                name: "ä¸œäº¬å¡”",
                                type: "spot",
                                lat: 35.6586,
                                lng: 139.7454,
                                date: "2024-04-05",
                                description: "ä¸œäº¬çš„è±¡å¾ï¼Œé«˜333ç±³ï¼Œçº¢ç™½ç›¸é—´çš„å¡”èº«è®¾è®¡çµæ„Ÿæ¥è‡ªåŸƒè²å°”é“å¡”ã€‚",
                                icon: "ğŸ—¼"
                            },
                            {
                                id: "jp-tokyo-sensoji",
                                name: "æµ…è‰å¯º",
                                type: "spot",
                                lat: 35.7148,
                                lng: 139.7967,
                                date: "2024-04-06",
                                description: "ä¸œäº¬æœ€å¤è€çš„å¯ºåº™ï¼Œè‘—åçš„é›·é—¨å’Œä»²è§ä¸–å•†åº—è¡—æ˜¯æ¸¸å®¢å¿…åˆ°ä¹‹å¤„ã€‚",
                                icon: "â›©ï¸"
                            },
                            {
                                id: "jp-tokyo-shibuya",
                                name: "æ¶©è°·åå­—è·¯å£",
                                type: "spot",
                                lat: 35.6595,
                                lng: 139.7004,
                                date: "2024-04-07",
                                description: "ä¸–ç•Œä¸Šæœ€ç¹å¿™çš„äººè¡Œæ¨ªé“ï¼Œæ¯åˆ†é’Ÿçº¦æœ‰3000äººåŒæ—¶ç©¿è¶Šï¼Œæ˜¯ä¸œäº¬ç°ä»£åŒ–çš„è±¡å¾ã€‚",
                                icon: "ğŸš¶"
                            }
                        ]
                    },
                    {
                        id: "jp-kyoto",
                        name: "äº¬éƒ½",
                        type: "city",
                        lat: 35.0116,
                        lng: 135.7681,
                        zoom: 11,
                        children: [
                            {
                                id: "jp-kyoto-fushimi",
                                name: "ä¼è§ç¨»è·å¤§ç¤¾",
                                type: "spot",
                                lat: 34.9671,
                                lng: 135.7727,
                                date: "2024-04-10",
                                description: "ä»¥åƒæœ¬é¸Ÿå±…é—»åï¼Œæ˜¯äº¬éƒ½æœ€å…·ä»£è¡¨æ€§çš„ç¥ç¤¾ä¹‹ä¸€ï¼Œä¾›å¥‰ç¨»è·ç¥ã€‚",
                                icon: "â›©ï¸"
                            },
                            {
                                id: "jp-kyoto-kinkakuji",
                                name: "é‡‘é˜å¯º",
                                type: "spot",
                                lat: 35.0394,
                                lng: 135.7292,
                                date: "2024-04-11",
                                description: "æ­£å¼åç§°ä¸ºé¹¿è‹‘å¯ºï¼Œæ ¸å¿ƒå»ºç­‘èˆåˆ©æ®¿å¤–å¢™ä»¥é‡‘ç®”è£…é¥°ï¼Œæ˜¯äº¬éƒ½çš„è±¡å¾ã€‚",
                                icon: "ğŸ›•"
                            }
                        ]
                    }
                ]
            },
            {
                id: "fr",
                name: "æ³•å›½",
                type: "country",
                lat: 46.2276,
                lng: 2.2137,
                zoom: 5,
                children: [
                    {
                        id: "fr-paris",
                        name: "å·´é»",
                        type: "city",
                        lat: 48.8566,
                        lng: 2.3522,
                        zoom: 12,
                        children: [
                            {
                                id: "fr-paris-eiffel",
                                name: "åŸƒè²å°”é“å¡”",
                                type: "spot",
                                lat: 48.8584,
                                lng: 2.2945,
                                date: "2024-06-15",
                                description: "å·´é»çš„è±¡å¾ï¼Œé«˜324ç±³ï¼Œæ˜¯ä¸–ç•Œè‘—åå»ºç­‘ï¼Œä¹Ÿæ˜¯æ³•å›½æ–‡åŒ–è±¡å¾ä¹‹ä¸€ã€‚",
                                icon: "ğŸ—¼"
                            },
                            {
                                id: "fr-paris-louvre",
                                name: "å¢æµ®å®«",
                                type: "spot",
                                lat: 48.8606,
                                lng: 2.3376,
                                date: "2024-06-16",
                                description: "ä¸–ç•Œå››å¤§åšç‰©é¦†ä¹‹é¦–ï¼ŒåŸæ˜¯æ³•å›½çš„ç‹å®«ï¼Œå±…ä½è¿‡50ä½æ³•å›½å›½ç‹å’Œç‹åã€‚",
                                icon: "ğŸ›ï¸"
                            },
                            {
                                id: "fr-paris-nd",
                                name: "å·´é»åœ£æ¯é™¢",
                                type: "spot",
                                lat: 48.8530,
                                lng: 2.3499,
                                date: "2024-06-17",
                                description: "å“¥ç‰¹å¼å»ºç­‘çš„ä»£è¡¨ä½œï¼Œä½äºå¡çº³æ²³ç•”çš„è¥¿å²±å²›ä¸Šï¼Œæ˜¯å·´é»æœ€å¤è€çš„å¤©ä¸»æ•™å ‚ã€‚",
                                icon: "â›ª"
                            }
                        ]
                    }
                ]
            },
            {
                id: "us",
                name: "ç¾å›½",
                type: "country",
                lat: 37.0902,
                lng: -95.7129,
                zoom: 4,
                children: [
                    {
                        id: "us-nyc",
                        name: "çº½çº¦",
                        type: "city",
                        lat: 40.7128,
                        lng: -74.0060,
                        zoom: 12,
                        children: [
                            {
                                id: "us-nyc-liberty",
                                name: "è‡ªç”±å¥³ç¥åƒ",
                                type: "spot",
                                lat: 40.6892,
                                lng: -74.0445,
                                date: "2024-07-20",
                                description: "æ³•å›½é€ç»™ç¾å›½çš„ç¤¼ç‰©ï¼Œè±¡å¾ç€è‡ªç”±å’Œæ°‘ä¸»ï¼Œæ˜¯ç¾å›½çš„æ ‡å¿—æ€§å»ºç­‘ã€‚",
                                icon: "ğŸ—½"
                            },
                            {
                                id: "us-nyc-times",
                                name: "æ—¶ä»£å¹¿åœº",
                                type: "spot",
                                lat: 40.7580,
                                lng: -73.9855,
                                date: "2024-07-21",
                                description: "è¢«ç§°ä¸ºä¸–ç•Œçš„åå­—è·¯å£ï¼Œæ˜¯çº½çº¦æœ€ç¹åçš„è¡—åŒºï¼Œä»¥å·¨å¤§çš„å¹¿å‘Šç‰Œé—»åã€‚",
                                icon: "ğŸŒƒ"
                            },
                            {
                                id: "us-nyc-central",
                                name: "ä¸­å¤®å…¬å›­",
                                type: "spot",
                                lat: 40.7829,
                                lng: -73.9654,
                                date: "2024-07-22",
                                description: "çº½çº¦æœ€å¤§çš„éƒ½å¸‚å…¬å›­ï¼Œå åœ°341å…¬é¡·ï¼Œæ˜¯åŸå¸‚ä¸­çš„ç»¿æ´²ã€‚",
                                icon: "ğŸŒ³"
                            }
                        ]
                    }
                ]
            }
        ];

        // åœ°å›¾ç›¸å…³å˜é‡
        let map;
        let currentLayer;
        let currentLevel = 'world';
        let currentPath = [];
        let markers = [];
        let failedTiles = 0;
        let totalTiles = 0;

        // åœ°å›¾æºé…ç½®
        const mapSources = {
            cartodb: {
                name: 'CartoDB',
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright ">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions ">CARTO</a>',
                subdomains: ['abcd', 'abcd', 'abcd', 'abcd'],
                maxZoom: 19
            },
            osm: {
                name: 'OpenStreetMap',
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright ">OpenStreetMap</a>',
                subdomains: ['a', 'b', 'c'],
                maxZoom: 19
            },
            stamen: {
                name: 'Stamen',
                url: 'https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright ">OpenStreetMap</a> &copy; <a href="http://stamen.com ">Stamen Design</a>',
                subdomains: ['a', 'b', 'c', 'd'],
                maxZoom: 18
            },
            esri: {
                name: 'ESRI',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/ {z}/{y}/{x}',
                attribution: '&copy; <a href="https://www.esri.com/ ">ESRI</a>',
                subdomains: ['server', 'services'],
                maxZoom: 18
            }
        };

        // åˆå§‹åŒ–
        function init() {
            initMap();
            renderTree();
            updateStats();
            document.getElementById('loading-indicator').style.display = 'none';
        }

        function initMap() {
            showLoading(true);

            map = L.map('map', {
                zoomControl: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                worldCopyJump: true
            }).setView([30, 0], 3);

            // ç›‘å¬ç“¦ç‰‡åŠ è½½äº‹ä»¶
            map.on('tileloadstart', function() {
                totalTiles++;
            });

            map.on('tileerror', function(e) {
                failedTiles++;
                if (failedTiles > 3) {
                    showTileError(true);
                }
            });

            map.on('load', function() {
                showLoading(false);
                if (failedTiles > 0) {
                    showNotification(`åŠ è½½å®Œæˆï¼Œ${failedTiles}ä¸ªç“¦ç‰‡åŠ è½½å¤±è´¥`);
                }
            });

            // æ·»åŠ é»˜è®¤å›¾å±‚
            changeMapSource('cartodb');

            // ç›‘å¬åœ°å›¾ç§»åŠ¨äº‹ä»¶
            map.on('moveend', checkMapLoadStatus);

            // ç›‘å¬ç¼©æ”¾äº‹ä»¶
            map.on('zoomend', function() {
                document.getElementById('stat-zoom').textContent = map.getZoom();
            });

            // æ˜¾ç¤ºä¸–ç•Œè§†å›¾
            showLevel('world');
        }

        // åˆ‡æ¢åœ°å›¾æº
        function changeMapSource(sourceName) {
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            const source = mapSources[sourceName];
            
            currentLayer = L.tileLayer(source.url, {
                attribution: source.attribution,
                maxZoom: source.maxZoom,
                subdomains: source.subdomains,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7lsIHpnaLlm77niYfmuLjmuLLvvIzkuI3mlLnlj5HkvZPvvIw+PC90ZXh0Pjwvc3ZnPg==',
                timeout: 8000
            });

            currentLayer.on('load', function() {
                showLoading(false);
                if (failedTiles === 0) {
                    showNotification('åœ°å›¾åŠ è½½æˆåŠŸï¼', 'success');
                }
            });

            currentLayer.on('error', function(e) {
                showNotification('åœ°å›¾æºåŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æº', 'error');
                showLoading(false);
            });

            currentLayer.addTo(map);

            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.source-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`input[value="${sourceName}"]`).parentElement.classList.add('active');
        }

        // æ˜¾ç¤ºæŒ‡å®šå±‚çº§
        function showLevel(levelId, parentPath = []) {
            currentLevel = levelId;
            currentPath = parentPath;
            
            clearMarkers();
            updateBreadcrumb();
            
            if (levelId === 'world') {
                // æ˜¾ç¤ºæ‰€æœ‰å›½å®¶
                geoData.forEach(country => {
                    addMarker(country, 'country');
                });
                map.setView([30, 0], 2);
            } else {
                // æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹
                let currentNode = findNode(geoData, levelId);
                if (currentNode) {
                    if (currentNode.children) {
                        currentNode.children.forEach(child => {
                            addMarker(child, child.type);
                        });
                        map.setView([currentNode.lat, currentNode.lng], currentNode.zoom || 5);
                    } else {
                        // æ˜¯æ™¯ç‚¹ï¼Œæ˜¾ç¤ºè¯¦æƒ…
                        showSpotDetail(currentNode);
                        map.setView([currentNode.lat, currentNode.lng], 16);
                    }
                }
            }
            
            renderTree();
        }

        // æŸ¥æ‰¾èŠ‚ç‚¹
        function findNode(nodes, id) {
            for (let node of nodes) {
                if (node.id === id) return node;
                if (node.children) {
                    let found = findNode(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        // æ·»åŠ æ ‡è®°
        function addMarker(data, type) {
            const iconClass = type === 'country' ? 'country' : type === 'city' ? 'city' : 'spot';
            const iconSize = type === 'country' ? '24px' : type === 'city' ? '20px' : '16px';
            
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="marker-pin ${iconClass}">
                        <div class="marker-icon" style="font-size: ${iconSize};">
                            ${type === 'country' ? 'ğŸ³ï¸' : type === 'city' ? 'ğŸ™ï¸' : data.icon || 'ğŸ“'}
                        </div>
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            const marker = L.marker([data.lat, data.lng], { icon: icon })
                .addTo(map)
                .bindPopup(`
                    <div class="custom-popup">
                        <h3>${data.name}</h3>
                        <div class="popup-path">${getPathString()} > ${data.name}</div>
                        ${data.date ? `<div class="popup-date">ğŸ“… ${data.date}</div>` : ''}
                        ${data.description ? `<div class="popup-desc">${data.description}</div>` : ''}
                    </div>
                `);

            marker.on('click', () => {
                if (data.children && data.children.length > 0) {
                    showLevel(data.id, [...currentPath, data]);
                } else if (type === 'spot') {
                    showSpotDetail(data);
                }
            });

            marker.locationId = data.id;
            markers.push(marker);
        }

        // æ¸…é™¤æ ‡è®°
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // æ›´æ–°é¢åŒ…å±‘
        function updateBreadcrumb() {
            const container = document.getElementById('breadcrumb');
            let html = '<span class="breadcrumb-item" onclick="showLevel(\'world\')">ä¸–ç•Œ</span>';
            
            currentPath.forEach((item, index) => {
                html += `<span class="breadcrumb-separator">></span>`;
                html += `<span class="breadcrumb-item" onclick="showLevel('${item.id}', ${JSON.stringify(currentPath.slice(0, index))})">${item.name}</span>`;
            });
            
            container.innerHTML = html;
        }

        // è·å–è·¯å¾„å­—ç¬¦ä¸²
        function getPathString() {
            return ['ä¸–ç•Œ', ...currentPath.map(p => p.name)].join(' > ');
        }

        // æ¸²æŸ“æ ‘å½¢åˆ—è¡¨
        function renderTree() {
            const container = document.getElementById('tree-list');
            container.innerHTML = '';
            
            let dataToRender = currentLevel === 'world' ? geoData : 
                              findNode(geoData, currentLevel)?.children || [];
            
            // å¦‚æœå½“å‰æ˜¯æ™¯ç‚¹çº§åˆ«ï¼Œæ˜¾ç¤ºåŒçº§æ™¯ç‚¹
            if (!dataToRender.length && currentPath.length > 0) {
                let parent = currentPath[currentPath.length - 1];
                dataToRender = parent.children || [];
            }

            dataToRender.forEach(item => {
                const li = document.createElement('li');
                li.className = 'tree-item';
                
                const hasChildren = item.children && item.children.length > 0;
                const isActive = currentPath.some(p => p.id === item.id) || currentLevel === item.id;
                
                li.innerHTML = `
                    <div class="tree-header ${isActive ? 'active' : ''}" onclick="handleTreeClick('${item.id}', ${hasChildren})">
                        <div class="tree-icon icon-${item.type}">${getTypeIcon(item.type)}</div>
                        <div class="tree-content">
                            <div class="tree-title">${item.name}</div>
                            <div class="tree-subtitle">${item.children ? item.children.length + ' ä¸ªå­é¡¹' : (item.date || 'æ™¯ç‚¹')}</div>
                        </div>
                        ${hasChildren ? '<span class="expand-icon">â–¶</span>' : ''}
                    </div>
                `;
                
                container.appendChild(li);
            });
        }

        function getTypeIcon(type) {
            if (type === 'country') return 'ğŸ³ï¸';
            if (type === 'city') return 'ğŸ™ï¸';
            return 'ğŸ“';
        }

        function handleTreeClick(id, hasChildren) {
            let node = findNode(geoData, id);
            if (!node) return;
            
            if (hasChildren) {
                let newPath = [...currentPath];
                if (currentLevel !== 'world') {
                    let parent = findNode(geoData, currentLevel);
                    if (parent) newPath.push(parent);
                }
                showLevel(id, newPath);
            } else {
                // æ˜¯æ™¯ç‚¹
                showSpotDetail(node);
                map.setView([node.lat, node.lng], 16);
                // é«˜äº®å¯¹åº”æ ‡è®°
                markers.forEach(m => {
                    if (m.locationId === id) m.openPopup();
                });
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            let countries = 0, cities = 0, spots = 0;
            
            function count(node) {
                if (node.type === 'country') countries++;
                else if (node.type === 'city') cities++;
                else if (node.type === 'spot') spots++;
                
                if (node.children) node.children.forEach(count);
            }
            
            geoData.forEach(count);
            
            document.getElementById('stat-countries').textContent = countries;
            document.getElementById('stat-cities').textContent = cities;
            document.getElementById('stat-spots').textContent = spots;
        }

        // åœ°å›¾æ§åˆ¶åŠŸèƒ½
        function zoomIn() {
            if (map) map.zoomIn();
        }

        function zoomOut() {
            if (map) map.zoomOut();
        }

        function zoomToLevel(level) {
            if (map) map.setZoom(level);
        }

        function resetView() {
            showLevel('world');
            if (map) {
                map.setView([30, 0], 2);
            }
            closeSpotCard();
        }

        function refreshMap() {
            if (currentLayer) {
                currentLayer.redraw();
                showNotification('åœ°å›¾å·²åˆ·æ–°', 'success');
            }
        }

        // é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const indicator = document.getElementById('loading-indicator');
            if (show) {
                indicator.classList.add('show');
            } else {
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 500);
            }
        }

        function showTileError(show) {
            const overlay = document.getElementById('tile-error-overlay');
            if (show) {
                overlay.classList.add('show');
                setTimeout(() => {
                    overlay.classList.remove('show');
                }, 5000);
            } else {
                overlay.classList.remove('show');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('error-notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#ff5252' : 
                                          type === 'warning' ? '#ff9800' : 
                                          type === 'success' ? '#4CAF50' : '#2196F3';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function checkMapLoadStatus() {
            setTimeout(() => {
                if (failedTiles > totalTiles * 0.1) {
                    showNotification('åœ°å›¾åŠ è½½è´¨é‡è¾ƒå·®ï¼Œå»ºè®®åˆ‡æ¢æ•°æ®æº', 'warning');
                }
            }, 2000);
        }

        // åœ°å›¾æºåˆ‡æ¢äº‹ä»¶
        document.querySelectorAll('input[name="mapSource"]').forEach(radio => {
            radio.addEventListener('change', function() {
                changeMapSource(this.value);
            });
        });

        // çª—å£è°ƒæ•´
        window.onresize = () => {
            if (map) map.invalidateSize();
        };

        // å¯åŠ¨
        window.onload = init;
    </script>
</body>
</html>
